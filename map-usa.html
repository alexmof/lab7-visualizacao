<!--
	THIS EXAMPLE WAS DOWNLOADED FROM https://echarts.apache.org/examples/en/editor.html?c=map-usa-projection
-->
<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
  <meta charset="utf-8">
</head>

<body style="height: 100%; margin: 0">
  <select name="" id="sel" onchange="change()">
    <option value="EXP">Exportações</option>
    <option value="IMP" selected>Importções</option>
    <option value="BAL">Balança</option>
  </select>
  <div id="container" style="height: 100%"></div>

  <script type="text/javascript"
    src="https://echarts.apache.org/en/js/vendors/jquery@3.7.1/dist/jquery.min.js"></script>
  <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- Uncomment this line if you want to dataTool extension
  <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5/dist/extension/dataTool.min.js"></script>
  -->
  <!-- Uncomment this line if you want to use gl extension
  <script type="text/javascript" src="https://echarts.apache.org/en/js/vendors/echarts-gl/dist/echarts-gl.min.js"></script>
  -->
  <!-- Uncomment this line if you want to echarts-stat extension
  <script type="text/javascript" src="https://echarts.apache.org/en/js/vendors/echarts-stat/dist/ecStat.min.js"></script>
  -->
  <!-- Uncomment this line if you want to echarts-graph-modularity extension
  <script type="text/javascript" src="https://echarts.apache.org/en/js/vendors/echarts-graph-modularity/dist/echarts-graph-modularity.min.js"></script>
  -->
  <!-- Uncomment this line if you want to use map
  <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@4.9.0/map/js/world.js"></script>
  -->
  <!-- Uncomment these two lines if you want to use bmap extension
  <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=YOUR_API_KEY"></script>
  <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5/dist/extension/bmap.min.js"></script>
  -->

  <script type="text/javascript">
    // Inicia a instância do ECharts (supondo que 'myChart' já esteja inicializado)
    // var myChart = echarts.init(document.getElementById('main'));
    var dom = document.getElementById('container');
    var myChart = echarts.init(dom, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var app = {};
    var ROOT_PATH = 'https://echarts.apache.org/examples';
    var option;
    var selType = "IMP";
    const change = () => {
      selType = document.getElementById("sel").value;
      console.log(selType);
      myChart.showLoading();

    }

    myChart.showLoading();

    // Combina as duas lógicas: primeiro busca os dados do mapa, depois busca os seus dados de negócio.
    $.when(
      // 1. Carrega o arquivo GeoJSON do mapa-múndi
      $.get('https://cdn.jsdelivr.net/gh/apache/echarts-website@asf-site/examples/data/asset/geo/world.json'),

      // 2. Carrega o seu arquivo JSON de dados
      fetch('/BR-exportacoes_importacoes_2025.json').then(response => {
        if (!response.ok) {
          throw new Error('Erro ao carregar dados de negócio: ' + response.statusText);
        }
        return response.json();
      })

    ).done(function (mapResult, businessData) {
      // mapResult[0] contém o worldJson
      // businessData contém o resultado do seu fetch (o objeto dataB)
      const worldJson = mapResult[0];
      const dataB = businessData;

      myChart.hideLoading();

      // Registra o mapa-múndi no ECharts
      echarts.registerMap('world', worldJson);

      // --- PASSO DE TRANSFORMAÇÃO DOS DADOS ---
      // Escolha o ano e a métrica que deseja exibir no mapa
      const anoSelecionado = '2025';
      const metrica = 'us_value'; // Você pode trocar para 'kg_weight'

      // Transforma os dados do seu JSON para o formato que o ECharts entende
      var dadosParaMapa = dataB[selType][anoSelecionado].map(pais => {
        return {
          name: pais.name, // Nome do país
          value: pais[metrica] // Valor associado (US$ ou KG)
        };
      });
      // -----------------------------------------

      // Encontrar os valores mínimo e máximo para ajustar a legenda (visualMap)
      const valores = dadosParaMapa.map(item => item.value);
      const valorMin = Math.min(...valores);
      const valorMax = Math.max(...valores);

      const option = {
        title: {
          text: `Balança Comercial por País (${anoSelecionado})`,
          subtext: `Dados de BR-exportacoes_importacoes_2025.json`,
          left: 'center',
          top: 'top'
        },
        tooltip: {
          trigger: 'item',
          // Formata o tooltip para exibir o valor em formato de moeda ou peso
          formatter: function (params) {
            // Se não houver dados para o país, exibe apenas o nome
            if (!params.value) {
              return `${params.name}`;
            }
            // Formata o número para melhor leitura
            return `${params.name}<br/>${metrica}: ${params.value.toLocaleString('pt-BR')}`;
          }
        },
        visualMap: {
          left: 'left',
          // Ajusta dinamicamente o min e max da legenda
          min: valorMin,
          max: valorMax,
          inRange: {
            // Cores para valores negativos (vermelho), próximos de zero (amarelo) e positivos (azul)
            color: ['#d73027', '#fee090', '#4575b4']
          },
          text: ['Alto', 'Baixo'],
          calculable: true
        },
        series: [
          {
            name: `Balança Comercial (${metrica})`,
            type: 'map',
            map: 'world',
            roam: true, // Permite zoom e arrastar o mapa
            emphasis: {
              label: {
                show: true
              }
            },
            // USA OS DADOS TRANSFORMADOS AQUI
            data: dadosParaMapa
          }
        ]
      };

      myChart.setOption(option);

    }).fail(function (error) {
      // Se qualquer uma das requisições falhar
      myChart.hideLoading();
      console.error('Falha ao carregar os recursos necessários:', error);
      // Opcional: exibir uma mensagem de erro no próprio gráfico
      myChart.showLoading({
        text: 'Erro ao carregar dados. Verifique o console.',
        showSpinner: false,
        textColor: '#c23531'
      });
    });

  </script>
</body>

</html>